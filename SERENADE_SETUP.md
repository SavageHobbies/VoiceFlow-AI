# Serenade Custom Script Setup for WinAssistAI Wake Word

This guide explains how to set up a custom Serenade script to enable wake word functionality for WinAssistAI, allowing you to activate command listening by saying a specific word (e.g., "COMPUTER").

## Overview

WinAssistAI can be controlled more seamlessly by using a wake word (e.g., "COMPUTER"). This setup allows Serenade to wait for this specific wake word before processing subsequent speech. If the speech after the wake word matches a predefined WinAssistAI command, that command is executed. **If it does not match a predefined command, the speech is treated as a query for the conversational AI (e.g., OpenAI GPT), if configured.**

This enhanced interaction is primarily achieved by the `scripts/start-with-serenade.ps1` script, which now **automatically generates and configures the necessary custom Serenade script** for you.

## Prerequisites

- WinAssistAI installed.
- Serenade voice control application installed and operational.
- Your WinAssistAI project's `.env` file configured with your desired `WAKE_WORD` (and AI API keys if you want conversational AI).

## Automated Serenade Custom Script Setup (Recommended Method)

The `scripts/start-with-serenade.ps1` script now handles the creation and configuration of the required Serenade custom JavaScript file (`winassistai-serenade.js`) in your Serenade user scripts directory (typically `$env:APPDATA\Serenade\scripts\` on Windows).

**When you run `.\scripts\start-with-serenade.ps1`:**

1.  It reads the `WAKE_WORD` from your WinAssistAI project's `.env` file (defaulting to "COMPUTER" if not set).
2.  It determines the correct absolute paths for `serenade-commands.json` and `serenade-bridge.ps1` from your WinAssistAI project.
3.  It takes the template from `scripts/serenade_custom_script_template.js`.
4.  It replaces placeholders in the template with your specific `WAKE_WORD` and the absolute paths.
5.  It writes the configured JavaScript file to your Serenade user scripts directory as `winassistai-serenade.js`.
6.  It ensures the Serenade user scripts directory exists.

**Therefore, manual copying and editing of the JavaScript template are no longer necessary if you use `start-with-serenade.ps1` to launch WinAssistAI.**

### Key User Action: Configure `.env`

Your main responsibility is to ensure the `WAKE_WORD` (and any AI-related API keys) are correctly set in your WinAssistAI project's **`.env` file**.

```env
# In your .env file (in the WinAssistAI project root)
WAKE_WORD=YOUR_CHOSEN_WAKE_WORD # e.g., COMPUTER, ASSISTANT, etc.
AI_PROVIDER=OpenAI
OPENAI_API_KEY=sk_your_openai_key...
# ... other settings ...
```

The `start-with-serenade.ps1` script will handle placing these configured values into the Serenade script.

### What if Serenade is already running?

If Serenade is already running when `start-with-serenade.ps1` updates the `winassistai-serenade.js` file, you may need to tell Serenade to "reload custom scripts" or restart Serenade for the changes to take effect. The `start-with-serenade.ps1` script will output a reminder about this.

## Understanding the Template (For Advanced Users or Manual Setup)

While `start-with-serenade.ps1` automates the setup, it's useful to understand the template it uses: `scripts/serenade_custom_script_template.js`. This file contains placeholders like `__WAKE_WORD_PLACEHOLDER__`, `__COMMANDS_FILE_PATH_PLACEHOLDER__`, and `__POWERSHELL_SCRIPT_BRIDGE_PLACEHOLDER__`.

**If you were to set up the Serenade script manually (NOT RECOMMENDED if using `start-with-serenade.ps1`):**
You would have to:
1.  Copy `scripts/serenade_custom_script_template.js` to your Serenade scripts directory (e.g., `$env:APPDATA\Serenade\scripts\winassistai-serenade.js`).
2.  Manually replace the placeholders in your copied file with:
    *   Your `WAKE_WORD` (must match your `.env` setting).
    *   The **absolute path** to `scripts/serenade-commands.json` in your WinAssistAI project.
    *   The **absolute path** to `scripts/serenade-bridge.ps1` in your WinAssistAI project.
    (Paths in JavaScript should use forward slashes `/`, e.g., `C:/Users/YourName/WinAssistAI/scripts/serenade-commands.json`).

**However, relying on `start-with-serenade.ps1` to do this ensures paths and the wake word are correctly inserted based on your project's current location and `.env` configuration.**

## Configuring Serenade Application

After the `winassistai-serenade.js` file is generated in your Serenade scripts directory:
- Serenade needs to be configured to load and use custom scripts. This is usually enabled by default.
- Consult the official Serenade documentation for how to manage and activate custom scripts if you encounter issues.
- If you have multiple custom scripts, ensure `winassistai-serenade.js` (or the one generated by the script) is active or not conflicting.

## Testing the Setup

1.  **Ensure `.env` is configured** with your desired `WAKE_WORD` (and AI keys if testing conversational AI).
2.  **Run `.\scripts\start-with-serenade.ps1`**. This will generate/update `winassistai-serenade.js`.
3.  **Ensure Serenade is running**. If `start-with-serenade.ps1` launched it, wait for it to initialize. If it was already running, consider telling Serenade to "reload custom scripts" or restarting it.
4.  **Test**:
    *   Say your configured `WAKE_WORD` (e.g., "COMPUTER").
    *   Then say a predefined command (e.g., "check weather") or a general query for the AI (e.g., "tell me a joke").
    *   Check for responses and any logs from Serenade or the PowerShell console.

## üìù Quick Setup Summary (Checklist) - Revised

To get wake word and conversational AI working with Serenade:

1.  **Configure WinAssistAI `.env` file:**
    *   Ensure `.env` exists in your WinAssistAI project root (copy from `.env.example` if needed).
    *   Set your desired `WAKE_WORD` (e.g., `WAKE_WORD=COMPUTER`).
    *   Fill in `OPENAI_API_KEY` and set `AI_PROVIDER="OpenAI"` for conversational AI (optional).
    *   Fill in `ELEVENLABS_API_KEY` for high-quality voice (optional).

2.  **Run the Main Startup Script:**
    *   Execute `.\scripts\start-with-serenade.ps1` from your WinAssistAI project root.
    *   This single script will automatically:
        *   Generate or update `scripts/serenade-commands.json` (which maps voice commands to your PowerShell scripts).
        *   Create or update `winassistai-serenade.js` in your Serenade user scripts directory (e.g., `$env:APPDATA\Serenade\scripts\` on Windows).
        *   Inject the `WAKE_WORD` (from your `.env` file) and the correct absolute paths (for `serenade-commands.json` and `serenade-bridge.ps1`) into the `winassistai-serenade.js` file.
        *   Launch Serenade if it's not already running.

3.  **Test Serenade Integration:**
    *   If Serenade was already running when you executed `start-with-serenade.ps1`, you might need to tell Serenade to "reload custom scripts" or restart it for the new/updated `winassistai-serenade.js` to take effect. The startup script will remind you of this.
    *   Test by saying your wake word, then a command (e.g., "COMPUTER check weather") or a general query for the AI (e.g., "COMPUTER tell me a story").

## How It Works

1.  The custom JavaScript runs within Serenade's environment.
2.  It uses `serenade.global().setOnRecognizedSpeech()` to listen to all speech recognized by Serenade.
3.  It first checks for the `WAKE_WORD`.
4.  Once the `WAKE_WORD` is detected, it sets a flag (`listeningForCommand = true`) and waits for the next speech input.
5.  The next speech input (or speech immediately following the wake word) is processed:
    a.  It's first compared against the predefined commands loaded from `COMMANDS_FILE_PATH`. If a match is found, the corresponding WinAssistAI script is executed via `serenade-bridge.ps1`.
    b.  **If no predefined command matches**, the entire recognized speech (after the wake word, if applicable) is packaged as a special command: `"ask-ai <the user's speech>"`.
6.  This command (either a predefined one or the "ask-ai" packaged query) is sent to `POWERSHELL_SCRIPT_BRIDGE` using `serenade.global().execute()`.
7.  The `serenade-bridge.ps1` script then:
    a.  If it's a predefined command, it executes the corresponding WinAssistAI PowerShell script.
    b.  If the command starts with `"ask-ai "`, it extracts the user's speech and passes it to `scripts/converse-with-ai.ps1`, which then interacts with the configured AI provider.
8.  The script handles both two-stage commands (e.g., "COMPUTER" ... "tell me a joke") and single-utterance commands (e.g., "COMPUTER tell me a joke").

## Troubleshooting

- **Wake Word Not Detected**:
    - Double-check the `WAKE_WORD` in your Serenade JS script matches what you're saying.
    - Check Serenade's logs for any errors when loading your custom script.
    - Ensure your microphone is working and Serenade is processing audio.
- **Command Not Executed After Wake Word (Predefined or AI Query)**:
    - **Predefined Commands**:
        - Verify `COMMANDS_FILE_PATH` in the JS script is correct and points to the generated `serenade-commands.json`. Ensure this JSON file is not empty and correctly formatted.
        - Ensure the command you are speaking exactly matches a key in `serenade-commands.json` (case-insensitivity is handled by the script).
    - **AI Queries**:
        - Ensure your `.env` file in the WinAssistAI project has `AI_PROVIDER` and the relevant API key (e.g., `OPENAI_API_KEY`) correctly set up.
        - Check Serenade logs for messages like "No predefined command match. Routing to AI..." to confirm it's taking that path.
        - Check the output of the PowerShell console where `serenade-bridge.ps1` and subsequently `converse-with-ai.ps1` run for any errors from the AI script (e.g., API key issues, connection problems).
    - **General**:
        - Verify the `POWERSHELL_SCRIPT_BRIDGE` path is correct in the JS script.
        - Check Serenade logs for any errors during command execution.
- **Path Issues**:
    - The most common issue will be incorrect paths for `COMMANDS_FILE_PATH` and `POWERSHELL_SCRIPT_BRIDGE`. Absolute paths are generally more reliable.
- **Serenade API**:
    - The template uses conceptual Serenade APIs like `serenade.global().readFile()` and `serenade.global().execute()`. If these APIs have different names or behaviors in your version of Serenade, the script will need adjustments. Refer to Serenade's official scripting documentation.

This setup provides a powerful way to integrate WinAssistAI with Serenade using a custom wake word for a more controlled voice interaction experience.
